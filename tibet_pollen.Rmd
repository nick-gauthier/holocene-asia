---
title: "Pollen-based reconstruction of growing degree days over Tibet"
output: html_notebook
---

# Setup and Preproccesing

Import the packages needed for this analysis. Also load a shapefile of China to use in plots.
```{r setup}
library(tidyverse)
library(readxl)
library(sf)
library(scico)
library(stars)
library(analogue)
library(rioja)
library(mgcv)

china <- rnaturalearth::ne_countries(country = 'China', returnclass = 'sf')
```

## Modern Pollen Data

Import the modern pollen data and site information.
```{r}
modern_sites <- read_excel('china pollen data/China modern pollen - info.xlsx', sheet = 2, skip = 1) %>%
  st_as_sf(coords = c(4,5), crs = 4326) %>%
  select(id = No., 
         site = `Site name`, 
         elev = `Elevation (m)`, 
         sample_type = `Sample type`, 
         source = `Data source`, 
         data_type = `Data type`, 
         modern_veg_map = `Modern vegetation information (the Vegetation Map of China)`, 
         modern_veg_samp = `Modern vegetation information (sample and its surroundings)`, 
         pot_veg = `Potential vegetation (for cultivated vegetation, aquatic vegetation and other cryptic vegetation)`)

modern_pollen <- read_excel('china pollen data/China modern pollen - data.xlsx', sheet = 2, skip = 1) %>%
  slice(-(1:2)) %>%
  select(-(Site:`Elevation (m)`)) %>%
  column_to_rownames(var = 'No.') %>%
  mutate(across(everything(), as.numeric))
```

Visualize the site data.
```{r echo=FALSE}
plot(modern_sites)
```

Plot some summaries of the site data.
```{r echo=FALSE}
count(modern_sites, sample_type) %>%
ggplot(aes(reorder(sample_type, n), n)) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  labs(title = 'Modern pollen sample distribution', y = 'Count', x = 'Sample type')
```

Check that all rows sum to 100, and no single value is greater than 100
```{r}
all.equal(sum(rowSums(modern_pollen)) / 100, nrow(pollen))

sum(rowSums(modern_pollen > 100))
```

## Fossil Pollen Data

```{r}
fossil_sites <- read_excel('china pollen data/China west fossil pollen - data.xlsx') %>%
  slice(-(1:2)) %>%
  select(`Site/Taxa`:Age) %>%
  separate(`Site/Taxa`, into = c('site', 'year'), sep = '_', extra = 'merge') %>%
  # this part required because there are sometimes extra '_'  in the site names
  separate(year, into = c('year1', 'year2'), sep = '_') %>% # this warning is ok
  mutate(site = if_else(is.na(year2), site, paste(site, year1, sep = '_'))) %>%
  select(-year1, -year2) %>%
  # the CAOTANH site has lat and long coordinates reversed
  mutate(lon = if_else(site == 'CAOTANH', Lat, Long),
         lat = if_else(site == 'CAOTANH', Long, Lat)) %>%
  select(-Long, -Lat) %>%
    st_as_sf(coords = c(4,5), crs = 4326)

# these are different from the associated raw data -- specifically lacking that "transect"
fossil_sites1 <- read_excel('china pollen data/China west fossil pollen - info.xlsx', skip = 1) %>%
  # this has two lat lon fields, the unselected ones appear to be in degrees and meters?
  select(site = Site, elev = `Alt (m)`, type = `Sample Type`, lon = `Lon (d)`, lat = `Lat (d)`) %>%
  # Tanggula Mt has flipped lat lon coordinates
  mutate(lon2 = if_else(site == 'Tanggula Mt Co', lat, lon),
         lat2 = if_else(site == 'Tanggula Mt Co', lon, lat),
         lon = lon2, lat = lat2) %>%
  select(-lon2, -lat2) %>%
  st_as_sf(coords = c(4,5), crs = 4326)
    
# these are the same locations as china west fossil pollen - data
fossil_sites2 <- read_excel('~/Downloads/China west fossil pollen - data from sites.xlsx') %>%
  select(Site:Age) %>%
    slice(-n()) %>% # the last row of this file are column sums, so drop it
  separate(Site, into = c('site', 'year'), sep = '_', extra = 'merge') %>%
  # this part required because there are sometimes extra '_'  in the site names
  separate(year, into = c('year1', 'year2'), sep = '_') %>% # this warning is ok
  mutate(site = if_else(is.na(year2), site, paste(site, year1, sep = '_'))) %>%
  select(-year1, -year2) %>%
  # the CAOTANH site has lat and long coordinates reversed
  mutate(lon = if_else(site == 'CaotanH', Lat, Long),
         lat = if_else(site == 'CaotanH', Long, Lat)) %>%
  select(-Long, -Lat) %>%
  st_as_sf(coords = c(4,5), crs = 4326)
```

```{r}
ggplot(china)  +
  geom_sf(data= china) +
  geom_sf(data = fossil_sites, color = 'red', size = 2) +
  geom_sf(data = fossil_sites1, color = 'green')
```

```{r}
## these are the same sites, the former has the data. not all sites in the original file are in the pollen file from jade
fossil_sites3 <- read_excel('~/Downloads/china-fossil-pollen-from Ni 2014.xlsx') %>%
  st_as_sf(coords = c(3,4), crs = 4326)

fossil_sites4 <- read_excel('~/Downloads/pollen sites fossil China - Ni 2014 palaeo3.xlsx') %>%
  st_as_sf(coords = c(8,9), crs = 4326)

ggplot(china)  +
  geom_sf(data= china) +
    geom_sf(data = fossil_sites4, color = 'blue', size = 2) +
  geom_sf(data = fossil_sites3, color = 'red') 
```

```{r}
fossil_pollen <- read_excel('china pollen data/China west fossil pollen - data.xlsx') %>%
  slice(-(1:2)) %>%
  column_to_rownames("Site/Taxa") %>%
  select(-(Long:Age)) %>%
  mutate(across(everything(), as.numeric))

# new fossil pollen data has some duplicated sample names with different values
fossil_pollen2 <- read_excel('~/Downloads/China west fossil pollen - data from sites.xlsx') %>%
  slice(-n()) %>% # the last row of this file are column sums, so drop it
  filter(Site != 'NAQ22_-010') %>% # the percentages from this sample only add to 5
  select(-Pinus_haploxylon) %>% # this taxon appears twice (with upper and lowercase H), delete this column as the total is much smaller
  select(-(Site:Age))

fossil_pollen3 <- read_excel('~/Downloads/china-fossil-pollen-from Ni 2014.xlsx') %>%
  select(-(`Site biomise`:Taxa))
```

Check that all rows sum to 100, and no single value is greater than 100
```{r}
all.equal(sum(rowSums(fossil_pollen)) / 100, nrow(fossil_pollen))
sum(rowSums(fossil_pollen > 100))

all.equal(sum(rowSums(fossil_pollen2)) / 100, nrow(fossil_pollen2))
sum(rowSums(fossil_pollen2 > 100))

all.equal(sum(rowSums(fossil_pollen3)) / 100, nrow(fossil_pollen3))
sum(rowSums(fossil_pollen3 > 100))

rowSums(fossil_pollen) %>% hist
rowSums(fossil_pollen2) %>% hist
rowSums(fossil_pollen3) %>% hist

dim(fossil_pollen)
dim(fossil_pollen2)
dim(fossil_pollen3)

setdiff(names(fossil_pollen), names(fossil_pollen2))
setdiff(names(fossil_pollen2), names(fossil_pollen))
```

# Modern Climate

## Modern Pollen 

Do a PCA on the modern pollen data to look at large scale pollen-climate relationships.

```{r}
pca <- prcomp(modern_pollen, scale. = FALSE)
pca_s <- prcomp(sqrt(modern_pollen), scale. = FALSE) # sqrt is hellinger transformation
```
```{r}
library(fastICA)
ica <- fastICA(modern_pollen, 9)
```

```{r}
screeplot(pca, npcs = 20)
screeplot(pca_s, type = 'lines', npcs = 20)
```
So PC1 is arboreal/non-arboreal. PC2 separates out sedges, grow along bodies of water, major grassland biomes
```{r}
pca$rotation[,1:2] %>% plot
pca$rotation[,1, drop = FALSE] %>% as.data.frame %>% filter(PC1 > .2 | PC1 < -.2)
pca$rotation[,2, drop = FALSE] %>% as.data.frame %>% filter(PC2 > .2 | PC2 < -.2)
```
```{r}
t(ica$A) %>% set
t(ica$A)[,1:2] %>% plot
t(ica$A)[,4:5] %>% plot

t(ica$A)[,1, drop = FALSE] %>% as.data.frame(row.names = names(modern_pollen)) %>% filter(V1 < -10)
t(ica$A)[,2, drop = FALSE] %>% as.data.frame(row.names = names(modern_pollen)) %>% filter(V1 > 10)
t(ica$A)[,3, drop = FALSE] %>% as.data.frame(row.names = names(modern_pollen)) %>% filter(V1 > 10)
t(ica$A)[,4, drop = FALSE] %>% as.data.frame(row.names = names(modern_pollen)) %>% filter(V1 > 10)
t(ica$A)[,5, drop = FALSE] %>% as.data.frame(row.names = names(modern_pollen)) %>% filter(V1 < -10)


```

Same patterns with the hellinger transformation
```{r}
pca_s$rotation[,1:2] %>% plot
pca_s$rotation[,1, drop = FALSE] %>% as.data.frame %>% filter(PC1 > .2 | PC1 < -.2)
pca_s$rotation[,2, drop = FALSE] %>% as.data.frame %>% filter(PC2 > .2 | PC2 < -.2)
```

## Climate relationships


```{r}
pc_scores <- pca$x %>% 
  as_tibble() %>%
  bind_cols(modern_sites, .) %>%
  select(PC1:PC9) %>%
  st_set_crs(4326)
pc_scores_s <- pca_s$x %>% 
  as_tibble() %>%
  bind_cols(modern_sites, .) %>%
  select(PC1:PC9) %>%
  st_set_crs(4326)
ica_scores <- ica$S %>% 
  as_tibble() %>%
  bind_cols(modern_sites, .) %>%
  select(V1:V9) %>%
  st_set_crs(4326)
```

```{r echo=FALSE}
pc_scores %>%
  as_tibble() %>%
  pivot_longer(PC1:PC9) %>%
  arrange(abs(value)) %>%
  st_as_sf() %>%
ggplot() +
  geom_sf(aes(color = value)) + 
  facet_wrap(~name) +
  geom_sf(data = china %>% select(-name), fill= NA) +
  scale_color_distiller(palette = 'RdBu', limits = c(-88, 88), direction = -1) +
  theme_bw()
```
```{r echo=FALSE}
pc_scores_s %>%
  as_tibble() %>%
  pivot_longer(PC1:PC9) %>%
  arrange(abs(value)) %>%
  st_as_sf() %>% 
ggplot() +
  geom_sf(aes(color = value)) + 
  facet_wrap(~name) +
  geom_sf(data = china %>% select(-name), fill= NA) +
  scale_color_distiller(palette = 'RdBu', limits = c(-10, 10), direction = -1) +
  theme_bw()
```
```{r echo=FALSE}
ica_scores %>%
  as_tibble() %>%
  pivot_longer(V1:V9) %>%
  arrange(abs(value)) %>%
  st_as_sf() %>% 
ggplot() +
  geom_sf(aes(color = value)) + 
  facet_wrap(~name) +
  geom_sf(data = china %>% select(-name), fill= NA) +
  scale_color_distiller(palette = 'RdBu', limits = c(-11, 11), direction = -1) +
  theme_bw()
```

```{r}
ggplot() +
    geom_sf(data= china) +
  geom_sf(data = pc_scores, aes(color = PC1)) + 
  scale_color_scico(palette = 'bamako', limits = c(-70, 70), direction = -1) +
  theme_bw() +
  ggtitle('Modern Arboreal/Non-Arboreal Pollen concentration')
```

```{r}
ggplot() +
    geom_sf(data= china) +
  geom_sf(data = pc_scores, aes(color = PC2)) + 
  scale_color_scico(palette = 'bamako', limits = c(-80, 80), direction = -1) +
  theme_bw() +
  ggtitle('Modern Sedge/Non-Sedge Pollen concentration')
```

## Modern Climate

```{r}
ref <- st_bbox(pc_scores) %>%
  st_as_stars(dx = 0.1)

clim <- c('~/Desktop/CHELSA_bio1_1981-2010_V.2.1.tif',
         '~/Desktop/CHELSA_bio12_1981-2010_V.2.1.tif',
         '~/Desktop/CHELSA_npp_1981-2010_V.2.1.tif',
         '~/Desktop/CHELSA_gdd0_1981-2010_V.2.1.tif',
         '~/Desktop/CHELSA_gdd5_1981-2010_V.2.1.tif',
         '~/Desktop/CHELSA_gdd10_1981-2010_V.2.1.tif') %>%
  read_stars() %>%
  st_crop(ref) %>%
  setNames(c('MAT', 'TAP', 'NPP', 'GDD0', 'GDD5', 'GDD10')) %>%
  mutate(GDD0 = replace_na(GDD0, 0),
         GDD5 = replace_na(GDD5, 0),
         GDD10 = replace_na(GDD10, 0)) %>%
  st_as_stars() #%>%
 # st_warp(ref, use_gdal = TRUE, method = 'average') %>%
  #setNames(c('MAT', 'TAP', 'NPP', 'GDD0', 'GDD5', 'GDD10'))
```

```{r}
plot(clim['MAT'])
plot(clim['TAP'])
plot(clim['NPP'])
plot(clim['GDD0'])
plot(clim['GDD5'])
plot(clim['GDD10'])
```


```{r}
clim %>%
  st_as_stars %>%
  as_tibble %>%
  ggplot(aes(MAT, GDD10)) +
  geom_point()
```


```{r}
pts <- st_extract(clim, at = pc_scores) # bilinear = TRUE causes this to fail for some reason
```

```{r}
library(mgcv)
dat_gam <- pc_scores %>%
  mutate(mat = pts$MAT,
         tap = pts$TAP,
         gdd10 = pts$GDD10,
         gdd0 = pts$GDD0,
         npp = pts$NPP,
         x = st_coordinates(.)[,1],
         y = st_coordinates(.)[,2])
```


```{r}
m1 <- gam(mat ~ s(PC1, bs = 'cr') + s(PC2, bs = 'cr'), method = 'REML', select = TRUE, data = dat_gam)
m2 <- gam(tap ~ s(PC1, bs = 'cr') + s(PC2, bs = 'cr'), method = 'REML', select = TRUE, data = dat_gam)
m3 <- gam(gdd10 ~ s(PC1, bs = 'cr') + s(PC2, bs = 'cr'), method = 'REML', select = TRUE, data = dat_gam)
m4 <- gam(npp ~ s(PC1, bs = 'cr') + s(PC2, bs = 'cr'), method = 'REML', select = TRUE, data = dat_gam)
m5 <- gam(gdd0 ~ s(PC1, bs = 'cr') + s(PC2, bs = 'cr'), method = 'REML', select = TRUE, data = dat_gam)

summary(m1)$r.sq
summary(m2)$r.sq
summary(m3)$r.sq
summary(m4)$r.sq
summary(m5)$r.sq
```

```{r}
plot(m1)
```

```{r}
plot(m2)
```

```{r}
plot(m3)
```

```{r}
plot(m4)
```
Only by incorporating space do you get a good fit above r2 of .50 and an RMSE competitive with MAT.
```{r}
space_mod <- bam(gdd10 ~ s(PC1, bs = 'cr') + s(PC2, bs = 'cr') + s(PC3, bs = 'cr') + s(PC4, bs = 'cr') + s(PC5, bs = 'cr') + te(x, y), select = TRUE, data = dat_gam)

nospace_mod <- bam(gdd10 ~ s(PC1, bs = 'cr') + s(PC2, bs = 'cr') + s(PC3, bs = 'cr') + s(PC4, bs = 'cr') + s(PC5, bs = 'cr'), select = TRUE, data = dat_gam)

gam.check(space_mod);gam.check(nospace_mod)
summary(space_mod);summary(nospace_mod)
plot(space_mod, residuals = TRUE, scheme = 2);plot(nospace_mod, residuals = TRUE, scheme = 2)
residuals(space_mod)^2 %>% mean %>% sqrt;residuals(nospace_mod)^2 %>% mean %>% sqrt

  AIC(nospace_mod,space_mod)
```

```{r}
pc_scores %>%
  ggplot(aes(PC1, PC2)) +
  geom_point(alpha = .2)
```
How about the forward model?
```{r}
m5 <- gam(PC1 ~ s(mat, bs = 'cr') + s(npp, bs = 'cr') + s(tap, bs = 'cr') + s(gdd10, bs = 'cr'), data = dat, method = 'REML', select = TRUE)

summary(m5)$r.sq
```
```{r}
plot(m5, scale = 0)
```
## Modern Analogue technique

```{r}
library(analogue)
```

```{r}
plot(pts)
```

```{r}
dat <- analogue::join(pollen, pollen_fossil, verbose = TRUE, type = 'inner')

cr(ImbrieKipp, SumSST, tranFun = Hellinger)
```



```{r}
gdd_pcr <- pcr(dat$pollen / 100, as_tibble(pts)$GDD10, ncomp = 10)
gdd_pcr_hell <- pcr(dat$pollen / 100, as_tibble(pts)$GDD10, ncomp = 10, tranFun = Hellinger)
gdd_pcr_sqrt <- pcr(sqrt(dat$pollen / 100), as_tibble(pts)$GDD10, ncomp = 10) # should be the same as above!

screeplot(gdd_pcr);screeplot(gdd_pcr_hell);screeplot(gdd_pcr_sqrt)
```

```{r}
gdd_mat
```

```{r}
summary(gdd_mat)
```
```{r}
getK(gdd_mat)
```

```{r}
plot(gdd_mat)
```

```{r}
gdd_boot <- bootstrap(gdd_mat, n.boot = 25)
gdd_boot
#setK(gdd_mat) <- getK(gdd_boot)
```

```{r}
plot(pts %>% select(GDD10))
```

```{r}
pastgdd <- predict(gdd_mat, dat$pollen_fossil / 100)
pastgdd$predictions$model$predicted %>% colMeans()
```

```{r}
pastgdd
```

```{r}
dat$pollen_fossil %>% as_tibble() %>% mutate(test = pastgdd)
```

```{r}

dat$pollen_fossil
as_tibble(pts)$GDD10
```


```{r}
library(rioja)
gdd_mat <- rioja::MAT(dat$pollen / 100, as_tibble(pts)$GDD10)
performance(gdd_mat)
summary(gdd_mat)
```

```{r}
plot(gdd_mat)
```

```{r}
print(gdd_mat)
```

```{r}
screeplot(gdd_mat)
```

```{r}
gdd_wapls <- rioja::WAPLS(dat$pollen / 100, as_tibble(pts)$GDD10, npls = 10, standx = FALSE)
gdd_cross <- crossval(gdd_wapls, cv.method = 'lgo', ngroups = 5)
summary(gdd_cross)
performance(gdd_cross)
screeplot(gdd_cross)
plot(gdd_cross)
```
```{r}
gdd_wa <- rioja::WA(dat$pollen / 100, as_tibble(pts)$GDD10) %>%
  crossval(cv.method = 'lgo', ngroups = 5)
summary(gdd_wa)
performance(gdd_wa)
plot(gdd_wa)
```
```{r}
gdd_mlrc <- rioja::MLRC(dat$pollen / 100, as_tibble(pts)$GDD10) %>%
  crossval(cv.method = 'lgo', ngroups = 5)
summary(gdd_mlrc)
performance(gdd_mlrc)
plot(gdd_mlrc)
```
```{r}
gdd_LWR <- rioja::LWR(dat$pollen / 100, as_tibble(pts)$GDD10) %>%
  crossval(cv.method = 'lgo', ngroups = 5)
summary(gdd_LWR)
performance(gdd_LWR)
plot(gdd_LWR)
```

```{r}
gdd_IKFA <- rioja::IKFA(dat$pollen / 100, as_tibble(pts)$GDD10, nFact = 10, IsPoly = TRUE) %>%
  crossval(cv.method = 'lgo', ngroups = 5)
summary(gdd_IKFA)
performance(gdd_IKFA)
screeplot(gdd_IKFA)
plot(gdd_IKFA)
```

```{r}
pastgdd <- predict(gdd_mat, dat$pollen_fossil / 100, k = 4)

fossil_loc2 <- read_excel('china pollen data/China west fossil pollen - data.xlsx') %>%
  slice(-(1:2)) %>%
  select(`Site/Taxa`:Age)

recon <- as_tibble(pastgdd$fit, rownames = 'Site/Taxa') %>%
  left_join(fossil_loc2) %>%
  separate(`Site/Taxa`, into = c('site', 'year'), sep = '_', extra = 'merge') %>%
  # this part required because there are sometimes extra '_'  in the site names
  separate(year, into = c('year1', 'year2'), sep = '_') %>% # this warning is ok
  mutate(site = if_else(is.na(year2), site, paste(site, year1, sep = '_'))) %>%
  select(-year1, -year2, -MAT) %>%
  rename(gdd10 = MAT.wm) %>%
  filter(Long > 60, Age < 12000)
```
```{r}
recon %>% count(site)
```
```{r}
plot(fossil)
```


```{r}

test <- bam(gdd10 ~ te(Long, Lat, Age, k = c(80, 20), d = c(2, 1), bs = c('tp', 'cr')), data = recon)

summary(test)
gam.check(test)
plot(test)
```

```{r}
recon;fossil
```


```{r}
plot(test)
```
```{r}
recon %>% filter(Age < 12000) %>% pull(Age) %>% hist
```

```{r}
china_hex <- china %>% 
  st_make_grid(n = 50, square = FALSE) %>% 
  st_as_sf() %>% 
  mutate(Long = st_coordinates(st_centroid(.))[,1],
         Lat = st_coordinates(st_centroid(.))[,2]) %>%
    filter(st_intersects(x, china, sparse = FALSE)) %>%
  mutate(id = 1:n())
   
map_dfr(c(0, 2000, 4000, 6000), ~ mutate(china_hex, Age = .)) %>%
    mutate(pred = predict(test, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_viridis_c(option = 'magma') +
    facet_wrap(~Age) +
  theme_bw() 
```

```{r}
mutate(china_hex, Age = 0) %>%
    mutate(pred = predict(test, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  mutate(Age = 6000) %>%
      mutate(pred2 = predict(test, ., type = 'response')) %>%
  mutate(pred2 = if_else(pred2 < 0, 0, pred2)) %>%
  mutate(pred = pred - pred2) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_distiller(palette ='RdBu', limits = c(-1900, 1900)) +
  ggtitle('Change in Growing Degree Days', 'Mid Holocene to Present') +
  theme_bw() 
```

```{r}
mutate(china_hex, Age = 3500) %>%
    mutate(pred = predict(test, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  mutate(Age = 6000) %>%
      mutate(pred2 = predict(test, ., type = 'response')) %>%
  mutate(pred2 = if_else(pred2 < 0, 0, pred2)) %>%
  mutate(pred = pred - pred2) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_distiller(palette ='RdBu') +
  ggtitle('Change in Growing Degree Days', 'Mid Holocene to Present') +
  geom_point(data = fossil_loc %>% filter(Long > 60), aes(Long, Lat)) +
  theme_bw() 
```

```{r}
map_dfr(seq(12000, 0, -1000), ~ mutate(china_hex, Age = .)) %>%
    mutate(pred = predict(test, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  ggplot() + geom_sf(aes(fill = pred > 2900) ,size = .1) + scale_fill_viridis_d(option = 'magma') +
    facet_wrap(~Age) +
  theme_bw() 
```

## Bins
```{r}
library(exactextractr)
gdd_dgg <- exact_extract(as(clim['GDD10'], 'Raster'), china_hex, 'mean')

china_hex %>% transmute(gdd_dgg) %>% ggplot() + geom_sf(aes(fill = gdd_dgg), size = .1) + scale_fill_viridis_c(option = 'magma') + theme_bw()
```
```{r}
china_hex %>% transmute(gdd_dgg) %>% ggplot() + geom_sf(aes(fill = gdd_dgg > 2900), size = .1) + scale_fill_viridis_d(option = 'magma') + theme_bw()
```
repeat with bins
```{r}
read_excel('china pollen data/China modern pollen - data.xlsx', sheet = 2, skip = 1) %>%
  slice(-(1:2)) %>%
  st_as_sf(coords = c(4,5), crs = 4326) %>%
 st_intersects(china_hex, .) %>%
  lengths %>%
  transmute(china_hex, .) %>% plot
```

```{r}
mod_hex_pol <- read_excel('china pollen data/China modern pollen - data.xlsx', sheet = 2, skip = 1) %>%
  slice(-(1:2)) %>%
  st_as_sf(coords = c(4,5), crs = 4326) %>%
  st_join(china_hex, join = st_within) %>% 
  select(Abelia:id) %>%
  st_drop_geometry() %>%
  mutate(across(everything(), as.numeric)) %>%
    group_by(id) %>%
  summarise(across(everything(), mean)) %>%
  left_join(select(china_hex, -Long, -Lat), .) %>%
  select(-Long, -Lat) %>% 
  st_drop_geometry() %>% as_tibble%>% select(-id) %>% 
  `/`(100)  



dat2 <- mod_hex_pol %>% mutate(gdd  = gdd_dgg) %>% remove_missing()

mat_bin <- rioja::MAT(dat2 %>% select(-gdd), dat2$gdd)
screeplot(mat_bin)
```


```{r}

fossil_loc_bin <- read_excel('china pollen data/China west fossil pollen - data.xlsx') %>%
  slice(-(1:2)) %>%
  st_as_sf(coords = c(2,3), crs = 4326) %>%
  st_join(china_hex, join = st_within) %>% 
  select(Age,`Abies+Picea`:id) %>%
  st_drop_geometry() %>%
  mutate(across(everything(), as.numeric)) %>%
  left_join(select(china_hex, -Long, -Lat), .) %>%
  select(-Long, -Lat)


fossil_poll_bin <- fossil_loc_bin %>% 
  st_drop_geometry() %>% as_tibble %>% remove_missing() %>% group_by(id, Age) %>% summarise(across(everything(), mean), .groups = 'drop') %>% mutate(no = interaction(id, Age, sep = '_')) %>% column_to_rownames(var = 'no') %>% 
  select(-id, -Age) %>%
  `/`(100)  

fossil_poll_bin_ages <- fossil_loc_bin %>% 
  st_drop_geometry() %>% as_tibble%>% select(id, Age) %>% remove_missing()

past_gdd_bin <- predict(mat_bin, fossil_poll_bin, k = 4)

recon_mod <- as_tibble(past_gdd_bin$fit, rownames = 'id') %>%
  separate(id, into = c('id', 'Age'), sep = '_') %>% 
  mutate(id = as.numeric(id), Age = as.numeric(Age)) %>%
 # left_join(fossil_poll_bin_ages) %>%
  select(id, Age, gdd10 = MAT.wm) %>%
  left_join(china_hex, by = 'id') %>%
  filter(Long > 60, Age < 10000) %>%
   bam(gdd10 ~ te(Long, Lat, Age, k = c(80, 20), d = c(2, 1), bs = c('tp', 'cr')), data = .)

summary(recon_mod)
plot(recon_mod)
```
```{r}

# not binned until end
mutate(china_hex, Age = 0) %>%
    mutate(pred = predict(test, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  mutate(Age = 6000) %>%
      mutate(pred2 = predict(test, ., type = 'response')) %>%
  mutate(pred2 = if_else(pred2 < 0, 0, pred2)) %>%
  mutate(pred = pred - pred2) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_distiller(palette ='RdBu', limits = c(-1900, 1900)) +
  theme_bw() 

#binned
mutate(china_hex, Age = 0) %>%
    mutate(pred = predict(recon_mod, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  mutate(Age = 6000) %>%
      mutate(pred2 = predict(recon_mod, ., type = 'response')) %>%
  mutate(pred2 = if_else(pred2 < 0, 0, pred2)) %>%
  mutate(pred = pred - pred2) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_distiller(palette ='RdBu', limits = c(-1900, 1900)) +
  theme_bw() 
```
```{r}
#why isn't there more variability here?
as_tibble(pastgdd$fit, rownames = 'id') %>%
  separate(id, into = c('id', 'Age')) %>%
  mutate( Age = as.numeric(Age)) %>%
 # left_join(fossil_poll_bin_ages) %>%
  select(id, Age, gdd10 = MAT.wm) %>%
  filter(Age < 7500) %>%
  ggplot(aes(-Age, gdd10, color = (id))) + 
  geom_point(alpha = .5) +
  geom_line(alpha = .3) +
  theme_bw() +
  guides(color = 'none')
```

```{r}
data(columb.polys) ## district shapes list

spdep::poly2nb(china_hex )
columb.polys
```

```{r}
raster::getData()
```

## FRK

```{r}
library(FRK)
library(sp)
data("AIRS_05_2003")
AIRS_05_2003
class(AIRS_05_2003)
coordinates(AIRS_05_2003) <- ~lon + lat
proj4string(AIRS_05_2003) <- CRS("+proj=longlat +ellps=sphere")
isea3h_sp_poldf <- auto_BAUs(manifold = sphere(), isea3h_res = 6, type = "hex", data = AIRS_05_2003)
isea3h_sp_poldf$fs <- 1
plot(isea3h_sp_poldf)
```

```{r}
G <- auto_basis(manifold = sphere(), data = AIRS_05_2003_t, nres = 3,isea3h_lo = 2, type = "bisquare")
```

```{r}
  mutate(china_hex, Age = 6000) %>%
      mutate(pred = predict(test, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_distiller(palette ='RdBu') +
  theme_bw() 
```



```{r}
mh_test_mod <- recon %>%
  filter(Age > 5550 & Age < 6450 ) %>%
  bam(gdd10 ~ te(Long, Lat, k = 10), data = .)
mutate(china_hex) %>%
    mutate(pred = predict(mh_test_mod, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_distiller(palette ='RdBu') +
  theme_bw() 
```

```{r}
mutate(china_hex, Age = 4200) %>%
    mutate(pred = predict(recon_mod, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_distiller(palette ='RdBu') +
  theme_bw() 
```

```{r}
  mutate(china_hex, Age = 4200) %>%
      mutate(pred = predict(test, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_distiller(palette ='RdBu') +
  theme_bw() 

mutate(china_hex, Age = 0) %>%
    mutate(pred = predict(test, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  mutate(Age = 4200) %>%
      mutate(pred2 = predict(test, ., type = 'response')) %>%
  mutate(pred2 = if_else(pred2 < 0, 0, pred2)) %>%
  mutate(pred = pred - pred2) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_distiller(palette ='RdBu') +
  theme_bw() 
```


## Tibet

```{r}
tibet_bbox <- st_bbox(c(xmin = 65, xmax = 105, ymin = 25, ymax = 45), crs = 4326)
tibet_mod <- recon %>%
  filter(between(Lat, 25, 45), between(Long, 65, 105)) %>%
   bam(gdd10 ~ te(Long, Lat, Age, k = c(80, 20), d = c(2, 1), bs = c('tp', 'cr')), data = .)
summary(tibet_mod)

```
```{r}
tibet_hex <- tibet_bbox %>% 
  st_make_grid(n = 50, square = FALSE) %>% 
  st_as_sf() %>% 
  mutate(Long = st_coordinates(st_centroid(.))[,1],
         Lat = st_coordinates(st_centroid(.))[,2]) %>%
  #  filter(st_intersects(x, china, sparse = FALSE)) %>%
  mutate(id = 1:n())

map_dfr(c(0, 2000, 4000, 6000), ~ mutate(tibet_hex, Age = .)) %>%
    mutate(pred = predict(tibet_mod, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_viridis_c(option = 'magma') +
    facet_wrap(~Age) +
  theme_bw() 
```

