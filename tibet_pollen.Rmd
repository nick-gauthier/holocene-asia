---
title: "Pollen-based reconstruction of growing degree days over Tibet"
output: html_notebook
---

# Setup and Preproccesing

Import the packages needed for this analysis. Also load a shapefile of China and the Tibetan Plateau to use in plots.
```{r setup}
library(tidyverse)
library(readxl)
library(sf)
library(scico)
library(stars)
library(rioja)
library(mgcv)
library(exactextractr)
library(fields)

china <- rnaturalearth::ne_countries(country = 'China', returnclass = 'sf')
tibet <- read_sf('~/Downloads/DBATP/DBATP_Polygon.shp') # source http://www.geodoi.ac.cn/weben/doi.aspx?Id=135
```

## Modern Pollen Data

Import the modern pollen data and site information.
```{r}
modern_sites <- read_excel('china pollen data/China modern pollen - info.xlsx', sheet = 2, skip = 1) %>%
  st_as_sf(coords = c(4,5), crs = 4326) %>%
  select(id = No., 
         site = `Site name`, 
         elev = `Elevation (m)`, 
         sample_type = `Sample type`, 
         source = `Data source`, 
         data_type = `Data type`, 
         modern_veg_map = `Modern vegetation information (the Vegetation Map of China)`, 
         modern_veg_samp = `Modern vegetation information (sample and its surroundings)`, 
         pot_veg = `Potential vegetation (for cultivated vegetation, aquatic vegetation and other cryptic vegetation)`)

modern_pollen <- read_excel('china pollen data/China modern pollen - data.xlsx', sheet = 2, skip = 1) %>%
  slice(-(1:2)) %>%
  select(-(Site:`Elevation (m)`)) %>%
  column_to_rownames(var = 'No.') %>%
  mutate(across(everything(), as.numeric))
```

Visualize the site data.
```{r echo=FALSE}
plot(modern_sites)
```

Plot some summaries of the site data.
```{r echo=FALSE}
count(modern_sites, sample_type) %>%
ggplot(aes(reorder(sample_type, n), n)) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  labs(title = 'Modern pollen sample distribution', y = 'Count', x = 'Sample type')
```
```{r}
ggplot(modern_sites) +
  geom_sf(data = china) +
  geom_sf(aes(color = sample_type)) +
  theme_bw()
```


Check that all rows sum to 100, and no single value is greater than 100
```{r}
all.equal(sum(rowSums(modern_pollen)) / 100, nrow(pollen))

sum(rowSums(modern_pollen > 100))
```

## Fossil Pollen Data

```{r}
fossil_sites <- read_excel('china pollen data/China west fossil pollen - data.xlsx') %>%
  slice(-(1:2)) %>%
  select(`Site/Taxa`:Age) %>%
  separate(`Site/Taxa`, into = c('site', 'year'), sep = '_', extra = 'merge') %>%
  # this part required because there are sometimes extra '_'  in the site names
  separate(year, into = c('year1', 'year2'), sep = '_') %>% # this warning is ok
  mutate(site = if_else(is.na(year2), site, paste(site, year1, sep = '_'))) %>%
  select(-year1, -year2) %>%
  # the CAOTANH site has lat and long coordinates reversed
  mutate(lon = if_else(site == 'CAOTANH', Lat, Long),
         lat = if_else(site == 'CAOTANH', Long, Lat)) %>%
  select(-Long, -Lat) %>%
  filter(site != 'PEARL14') %>%
  st_as_sf(coords = c(4,5), crs = 4326)

# these are different from the associated raw data -- specifically lacking that "transect"
fossil_sites1 <- read_excel('china pollen data/China west fossil pollen - info.xlsx', skip = 1) %>%
  # this has two lat lon fields, the unselected ones appear to be in degrees and meters?
  select(site = Site, elev = `Alt (m)`, type = `Sample Type`, lon = `Lon (d)`, lat = `Lat (d)`) %>%
  # Tanggula Mt has flipped lat lon coordinates
  mutate(lon2 = if_else(site == 'Tanggula Mt Co', lat, lon),
         lat2 = if_else(site == 'Tanggula Mt Co', lon, lat),
         lon = lon2, lat = lat2) %>%
  select(-lon2, -lat2) %>%
  st_as_sf(coords = c(4,5), crs = 4326)
    
# these are the same locations as china west fossil pollen - data
fossil_sites2 <- read_excel('~/Downloads/China west fossil pollen - data from sites.xlsx') %>%
  select(Site:Age) %>%
    slice(-n()) %>% # the last row of this file are column sums, so drop it
  separate(Site, into = c('site', 'year'), sep = '_', extra = 'merge') %>%
  # this part required because there are sometimes extra '_'  in the site names
  separate(year, into = c('year1', 'year2'), sep = '_') %>% # this warning is ok
  mutate(site = if_else(is.na(year2), site, paste(site, year1, sep = '_'))) %>%
  select(-year1, -year2) %>%
  # the CAOTANH site has lat and long coordinates reversed
  mutate(lon = if_else(site == 'CaotanH', Lat, Long),
         lat = if_else(site == 'CaotanH', Long, Lat)) %>%
  filter(site != 'Pearl14') %>%
  select(-Long, -Lat) %>%
  st_as_sf(coords = c(4,5), crs = 4326)
```

```{r}
ggplot(china)  +
  geom_sf(data= china) +
  geom_sf(data = fossil_sites, color = 'red', size = 2) +
  geom_sf(data = fossil_sites1, color = 'green')
```


```{r}
## these are the same sites, the former has the data. not all sites in the original file are in the pollen file from jade
fossil_sites3 <- read_excel('~/Downloads/china-fossil-pollen-from Ni 2014.xlsx') %>%
  st_as_sf(coords = c(3,4), crs = 4326)

fossil_sites4 <- read_excel('~/Downloads/pollen sites fossil China - Ni 2014 palaeo3.xlsx') %>%
  st_as_sf(coords = c(8,9), crs = 4326)

ggplot(china)  +
  geom_sf(data= china) +
    geom_sf(data = fossil_sites4, color = 'blue', size = 2) +
  geom_sf(data = fossil_sites3, color = 'red') 
```

```{r}
fossil_pollen <- read_excel('china pollen data/China west fossil pollen - data.xlsx') %>%
  slice(-(1:2)) %>%
  filter(!str_detect(`Site/Taxa`, 'PEARL')) %>% # the "transect"
  column_to_rownames("Site/Taxa") %>%
  select(-(Long:Age)) %>%
  mutate(across(everything(), as.numeric))

# new fossil pollen data has some duplicated sample names with different values
fossil_pollen2 <- read_excel('~/Downloads/China west fossil pollen - data from sites.xlsx') %>%
  slice(-n()) %>% # the last row of this file are column sums, so drop it
  filter(Site != 'NAQ22_-010', # the percentages from this sample only add to 5
         !str_detect(Site, 'Pearl')) %>% # the 'transect' 
  select(-Pinus_haploxylon) %>% # this taxon appears twice (with upper and lowercase H), delete this column as the total is much smaller
  select(-(Site:Age))

fossil_pollen3 <- read_excel('~/Downloads/china-fossil-pollen-from Ni 2014.xlsx') %>%
  select(-(`Site biomise`:Taxa))
```

Check that all rows sum to 100, and no single value is greater than 100
```{r}
all.equal(sum(rowSums(fossil_pollen)) / 100, nrow(fossil_pollen))
sum(rowSums(fossil_pollen > 100))

all.equal(sum(rowSums(fossil_pollen2)) / 100, nrow(fossil_pollen2))
sum(rowSums(fossil_pollen2 > 100))

all.equal(sum(rowSums(fossil_pollen3)) / 100, nrow(fossil_pollen3))
sum(rowSums(fossil_pollen3 > 100))

rowSums(fossil_pollen) %>% hist
rowSums(fossil_pollen2) %>% hist
rowSums(fossil_pollen3) %>% hist

dim(fossil_pollen)
dim(fossil_pollen2)
dim(fossil_pollen3)

setdiff(names(fossil_pollen), names(fossil_pollen2))
setdiff(names(fossil_pollen2), names(fossil_pollen))
```

# Modern Climate

## Modern Pollen 

Do a PCA on the modern pollen data to look at large scale pollen-climate relationships.

```{r}
pca <- prcomp(modern_pollen, scale. = FALSE)
pca_s <- prcomp(sqrt(modern_pollen), scale. = FALSE) # sqrt is hellinger transformation
```
```{r}
library(fastICA)
ica <- fastICA(modern_pollen, 9)
```

```{r}
screeplot(pca, npcs = 20)
screeplot(pca_s, type = 'lines', npcs = 20)
```
So PC1 is arboreal/non-arboreal. PC2 separates out sedges, grow along bodies of water, major grassland biomes
```{r}
pca$rotation[,1:2] %>% plot
pca$rotation[,1, drop = FALSE] %>% as.data.frame %>% filter(PC1 > .2 | PC1 < -.2)
pca$rotation[,2, drop = FALSE] %>% as.data.frame %>% filter(PC2 > .2 | PC2 < -.2)
```
```{r}
t(ica$A) %>% set
t(ica$A)[,1:2] %>% plot
t(ica$A)[,4:5] %>% plot

t(ica$A)[,1, drop = FALSE] %>% as.data.frame(row.names = names(modern_pollen)) %>% filter(V1 < -10)
t(ica$A)[,2, drop = FALSE] %>% as.data.frame(row.names = names(modern_pollen)) %>% filter(V1 > 10)
t(ica$A)[,3, drop = FALSE] %>% as.data.frame(row.names = names(modern_pollen)) %>% filter(V1 > 10)
t(ica$A)[,4, drop = FALSE] %>% as.data.frame(row.names = names(modern_pollen)) %>% filter(V1 > 10)
t(ica$A)[,5, drop = FALSE] %>% as.data.frame(row.names = names(modern_pollen)) %>% filter(V1 < -10)


```

Same patterns with the hellinger transformation
```{r}
pca_s$rotation[,1:2] %>% plot
pca_s$rotation[,1, drop = FALSE] %>% as.data.frame %>% filter(PC1 > .2 | PC1 < -.2)
pca_s$rotation[,2, drop = FALSE] %>% as.data.frame %>% filter(PC2 > .2 | PC2 < -.2)
```

### PCA


```{r}
pc_scores <- pca$x %>% 
  as_tibble() %>%
  bind_cols(modern_sites, .) %>%
  select(PC1:PC9) %>%
  st_set_crs(4326)
pc_scores_s <- pca_s$x %>% 
  as_tibble() %>%
  bind_cols(modern_sites, .) %>%
  select(PC1:PC9) %>%
  st_set_crs(4326)
ica_scores <- ica$S %>% 
  as_tibble() %>%
  bind_cols(modern_sites, .) %>%
  select(V1:V9) %>%
  st_set_crs(4326)
```

```{r echo=FALSE}
pc_scores %>%
  as_tibble() %>%
  pivot_longer(PC1:PC9) %>%
  arrange(abs(value)) %>%
  st_as_sf() %>%
ggplot() +
  geom_sf(aes(color = value)) + 
  facet_wrap(~name) +
  geom_sf(data = china %>% select(-name), fill= NA) +
  scale_color_distiller(palette = 'RdBu', limits = c(-88, 88), direction = -1) +
  theme_bw()
```
```{r echo=FALSE}
pc_scores_s %>%
  as_tibble() %>%
  pivot_longer(PC1:PC9) %>%
  arrange(abs(value)) %>%
  st_as_sf() %>% 
ggplot() +
  geom_sf(aes(color = value)) + 
  facet_wrap(~name) +
  geom_sf(data = china %>% select(-name), fill= NA) +
  scale_color_distiller(palette = 'RdBu', limits = c(-10, 10), direction = -1) +
  theme_bw()
```
```{r echo=FALSE}
ica_scores %>%
  as_tibble() %>%
  pivot_longer(V1:V9) %>%
  arrange(abs(value)) %>%
  st_as_sf() %>% 
ggplot() +
  geom_sf(aes(color = value)) + 
  facet_wrap(~name) +
  geom_sf(data = china %>% select(-name), fill= NA) +
  scale_color_distiller(palette = 'RdBu', limits = c(-11, 11), direction = -1) +
  theme_bw()
```

```{r}
ggplot() +
    geom_sf(data= china) +
  geom_sf(data = pc_scores, aes(color = PC1)) + 
  scale_color_scico(palette = 'bamako', limits = c(-70, 70), direction = -1) +
  theme_bw() +
  ggtitle('Modern Arboreal/Non-Arboreal Pollen concentration')
```

```{r}
ggplot() +
    geom_sf(data= china) +
  geom_sf(data = pc_scores, aes(color = PC2)) + 
  scale_color_scico(palette = 'bamako', limits = c(-80, 80), direction = -1) +
  theme_bw() +
  ggtitle('Modern Sedge/Non-Sedge Pollen concentration')
```

## Climate data

```{r}
cmfd <- list.files('~/Downloads/CMFD', full.names = TRUE) %>% map(~read_ncdf(., eps = 0.001, var = 'temp') %>%
  mutate(temp = units::set_units(temp, degree_C) %>% units::drop_units()) %>%
  transmute(gdd0 = if_else(temp > 0, temp, 0) - 0,
            gdd5 = if_else(temp > 5.5, temp, 5.5) - 5.5) %>%
  st_apply(1:2, sum) %>%
  merge()) %>%
  do.call(c, .)%>%
  merge(name = 'time') %>%
  st_set_dimensions('time', values = 1979:2018) %>%
  split('attributes')
gc()
```

```{r}
ggplot() +
  geom_stars(data = st_apply(cmfd['gdd0'], 1:2, mean)) +
  scale_fill_viridis_c(option = 'magma', na.value = NA) +
  theme_bw()
ggplot() +
  geom_stars(data = st_apply(cmfd['gdd5'], 1:2, mean)) +
  scale_fill_viridis_c(option = 'magma', na.value = NA) +
  theme_bw()
```
```{r}
pts <- st_extract(st_apply(cmfd, 1:2, mean), at = modern_sites)
```

Remove sites that fall outside the CMFD boundaries
```{r}
outside_ids <- pts %>%
  bind_cols(modern_sites) %>%
  filter(is.na(gdd0)) %>%
  pull(id)

modern_sites <- modern_sites %>% 
  filter(!(id %in% outside_ids))

modern_pollen <- modern_pollen %>%
  rownames_to_column() %>%
  filter(!(as.numeric(rowname) %in% outside_ids))

ggplot() +
  geom_stars(data = cmfd[1,,,1]) +
  geom_sf(data = pts, aes(color = is.na(gdd0))) +
  scale_color_viridis_d()
```

```{r}
pts <- st_extract(st_apply(cmfd, 1:2, mean), at = modern_sites)
```

## Modern Analogues

```{r}
dat <- Merge(modern_pollen, fossil_pollen, join = 'inner', split = TRUE)
```


```{r}
mat_gdd0 <- MAT(dat$modern_pollen / 100, as_tibble(pts)$gdd0 , lean = FALSE) %>%
  crossval(cv.method = 'lgo', ngroups = 5)
mat_gdd5 <- MAT(dat$modern_pollen / 100, as_tibble(pts)$gdd5, lean = FALSE) %>%
  crossval(cv.method = 'lgo', ngroups = 5)

screeplot(mat_gdd0);screeplot(mat_gdd5)
```

```{r}
plot(mat_gdd0, k = 3, wMean = TRUE);plot(mat_gdd5,k = 3, wMean = TRUE)
```

```{r}
modern_sites %>%
  mutate(gdd0_resid = mat_gdd0$residuals.cv[,'N03.wm'],
         gdd5_resid = mat_gdd5$residuals.cv[,'N03.wm']) %>%
  arrange(abs(gdd0_resid)) %>%
  ggplot() +
  geom_sf(data = china, fill = 'lightgrey') +
  geom_sf(aes(color = gdd0_resid)) +
  scale_color_distiller(palette = 'RdBu', limits = c(-8100, 8100)) +
  theme_bw()

modern_sites %>%
  mutate(gdd0_resid = mat_gdd0$residuals.cv[,'N03.wm'],
         gdd5_resid = mat_gdd5$residuals.cv[,'N03.wm']) %>%
  arrange(abs(gdd5_resid)) %>%
  ggplot() +
  geom_sf(data = china, fill = 'lightgrey') +
  geom_sf(aes(color = gdd5_resid)) +
  scale_color_distiller(palette = 'RdBu', limits = c(-6600, 6600)) +
  theme_bw()
```

```{r}
modern_sites %>%
  mutate(gdd0_resid = mat_gdd0$residuals.cv[,'N03.wm'],
         gdd5_resid = mat_gdd5$residuals.cv[,'N03.wm']) %>%
  filter(gdd0_resid > 8000)
```

H-block cross validation

```{r}
dist_mat <- st_distance(pts)

mat_gdd0_hblock <- MAT(dat$modern_pollen / 100, as_tibble(pts)$gdd0 , lean = FALSE) %>%
  crossval(cv.method = 'h-block', h.cutoff = units::set_units(100000, m), h.dist = dist_mat)
mat_gdd5 <- MAT(dat$modern_pollen / 100, as_tibble(pts)$gdd5, lean = FALSE) %>%
  crossval(cv.method = 'lgo', ngroups = 5)

screeplot(mat_gdd0);screeplot(mat_gdd0_hblock)

```

# Past Climate

Now reconstruct past climates at the fossil pollen sample sites.

```{r}
elev <- raster::getData('alt', country = 'CHN')

tibet_hex <- tibet %>%
  st_make_grid(n = 100, square = FALSE) %>% 
  st_as_sf() %>% 
  rename(geometry = x) %>%
  mutate(x = st_coordinates(st_centroid(.))[,1],
         y = st_coordinates(st_centroid(.))[,2]) %>%
  filter(st_within(geometry, tibet, sparse = FALSE)) %>%
  mutate(id = 1:n(),
         Alt = exact_extract(elev, ., 'mean'))
```


```{r}
ggplot() +
  geom_sf(data = tibet) +
  geom_sf(data = filter(fossil_sites, 
                        st_is_within_distance(geometry, tibet, dist = 400000, sparse = FALSE)), size = 2) +
  geom_sf(data = filter(fossil_sites3, 
                        st_is_within_distance(geometry, tibet, dist = 400000, sparse = FALSE)), color = 'green') 
```


```{r}
pastgdd0 <- predict(mat_gdd0, dat$fossil_pollen / 100, k = 3)
pastgdd5 <- predict(mat_gdd5, dat$fossil_pollen / 100, k = 3)

tibet_recon <- fossil_sites %>%
  mutate(gdd0 = pastgdd0$fit[,2],
         gdd5 = pastgdd5$fit[,2],
         x = st_coordinates(geometry)[,1],
         y = st_coordinates(geometry)[,2]) %>%
  filter(Age <= 7000) %>%
  filter(st_is_within_distance(geometry, tibet, dist = 400000, sparse = FALSE)) %>% # only get sites within 100km of the plateau
  st_drop_geometry() %>%
  as_tibble()
```


```{r}
as_tibble(pastgdd0$fit, rownames = 'id') %>%
  separate(id, into = c('id', 'Age')) %>%
  mutate( Age = as.numeric(Age)) %>%
  select(id, Age, gdd0 = MAT.wm) %>%
  filter(between(Age, 3500, 4500)) %>%
  ggplot(aes(-Age, gdd0, color = (id))) + 
  geom_line(alpha = .3) +
  theme_bw() +
  geom_smooth() +
  guides(color = 'none')
```

## Interpolation


```{r}
test_tps <- Tps(tibet_recon[,c(6,7,2,3)], tibet_recon$gdd0)
plot(test_tps)
summary(test_tps)
```

```{r}
new_prd <- map_dfr(c(0, 2000, 4000, 6000), ~ mutate(tibet_hex, Age = .)) %>%
    as_tibble %>%
  select(x,y,Alt, Age) %>%
remove_missing() %>%
      mutate(pred = predict(test_tps,x = .)) %>%
  mutate(pred = if_else(pred < 0, 0, pred))

map_dfr(c(0, 2000, 4000, 6000), ~ mutate(tibet_hex, Age = .)) %>%
  remove_missing() %>%
  mutate(pred = new_prd$pred) %>%
  ggplot() + 
  geom_sf(aes(fill = pred) ,size = .1) + 
  scale_fill_viridis_c(option = 'magma') +
  facet_wrap(~Age) + 
  geom_sf(data = tibet, fill = NA) +
  geom_sf(data = fossil_sites %>% filter(Age <= 9000) %>% group_by(site) %>% slice_sample(n = 1) %>% select(-Age) %>% ungroup %>%
  filter(st_is_within_distance(geometry, tibet, dist = 400000, sparse = FALSE)), alpha = .5) +
  theme_bw() 
```


```{r}
tibet_hex %>% transmute(gdd0 = exact_extract(as(st_apply(cmfd['gdd0'], 1:2, mean), 'Raster'), ., 'mean')) %>% ggplot() + geom_sf(aes(fill = gdd0), size = .1) + scale_fill_viridis_c(option = 'magma') + theme_bw()
```


```{r}
mutate(china_hex, Age = 0) %>%
    mutate(pred = predict(test, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  mutate(Age = 6000) %>%
      mutate(pred2 = predict(test, ., type = 'response')) %>%
  mutate(pred2 = if_else(pred2 < 0, 0, pred2)) %>%
  mutate(pred = pred - pred2) %>%
  ggplot() + geom_sf(aes(fill = pred) ,size = .1) + scale_fill_distiller(palette ='RdBu', limits = c(-1900, 1900)) +
  ggtitle('Change in Growing Degree Days', 'Mid Holocene to Present') +
  theme_bw() 
```


```{r}
map_dfr(seq(7000, 0, -1000), ~ mutate(tibet_hex, Age = .)) %>%
    mutate(pred = predict(test4, ., type = 'response')) %>%
  mutate(pred = if_else(pred < 0, 0, pred)) %>%
  ggplot() + geom_sf(aes(fill = pred > 1907) ,size = .1) + scale_fill_viridis_d(option = 'magma') +
    facet_wrap(~Age) +
  theme_bw() 
```

## Niche shifts

# Other Methods

Comparison of other pollen reconstruction methods.

```{r}
gdd_wapls <- WAPLS(sqrt(dat$modern_pollen[,-298] / 100), as_tibble(pts)$gdd0, 
                           npls = 10,
                           standx = FALSE) %>% 
  crossval(cv.method = 'h-block', h.cutoff = units::set_units(200000, m), h.dist = dist_mat)
screeplot(gdd_wapls)
plot(gdd_wapls, npls = 4)
```

```{r}
gdd_LWR <- rioja::LWR(sqrt(dat$modern_pollen / 100), as_tibble(pts)$gdd0) %>%
  crossval(cv.method = 'lgo', ngroups = 5)
plot(gdd_LWR)

length(gdd_LWR$x)
plot(gdd_LWR$x, gdd_LWR$predicted[,1])

colSums(dat$modern_pollen)
```

```{r}
gdd_IKFA <- rioja::IKFA(dat$modern_pollen[,-298] / 100, as_tibble(pts)$gdd0, nFact = 15) %>%
  crossval(cv.method = 'h-block', h.cutoff = units::set_units(200000, m), h.dist = dist_mat)

screeplot(gdd_IKFA)
plot(gdd_IKFA, nFact)

gdd_IKFA$ccoef
```

