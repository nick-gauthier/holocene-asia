---
title: "japan map"
author: "Nick Gauthier"
date: "9/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

countries <- rnaturalearth::ne_countries(country = c('Japan', 
                                                     'South Korea', 
                                                     'North Korea'), 
                                         returnclass = 'sf', 
                                         scale = 'medium')
plot(countries)
```

```{r}
gdd <- read_stars('~/Desktop/CHELSA_V2_bio_clim/CHELSA_gdd10_1981-2010_V.2.1.tif') %>%
  st_crop(countries) %>%
  setNames('GDD10')
```

```{r}
ggplot() +
  geom_stars(data = gdd) +
  scale_fill_viridis_c(option = 'magma', na.value = NA) +
  geom_sf(data = countries, fill = NA) +
  coord_sf(ylim = c(30, 45)) +
  theme_bw()
```
```{r}
gdd_class <- gdd %>% 
  transmute(niche = case_when(GDD10 > 3300 ~ 'Tropical Japonica (130 day)',
                              GDD10 > 3000 ~ 'Temperate Japonica (150 day) and Indica (120 day)',
                              GDD10 > 2900 ~ 'Tropical Japonica (120 day)',
                              GDD10 > 2500 ~ 'Temperate Japonica (130 day)',
                              GDD10 > 2400 ~ 'Indica (110 day)',
                              !is.na(GDD10) ~ 'None') %>%
              factor(levels = c('None', 'Indica (110 day)', 
                                'Temperate Japonica (130 day)', 
                                'Tropical Japonica (120 day)', 
                                'Indica (120 day) or Temperate Japonica (150 day)', 
                                'Tropical Japonica (130 day)'))) 
```

```{r}
ggplot() +
  geom_stars(data = gdd_class) +
  scale_fill_brewer(palette = 'Spectral', direction = -1, na.value = NA) +
  geom_sf(data = countries, fill = NA) +
  coord_sf(ylim = c(30, 45)) +
  theme_bw()
```

## Polish Army Polygons

```{r}
rice_polys <- read_sf('japan_poly.shp') %>% 
  select(-id) %>% 
  replace_na(replace = list(type = 'rice')) %>%
  st_make_valid() %>%
  mutate(type = as.factor(type))
```

```{r}
plot(rice_polys)
```
```{r}
poly_mean <- aggregate(gdd, rice_polys, mean, na.rm = TRUE, exact = TRUE)
poly_sd <- aggregate(gdd, rice_polys, mean, na.rm = TRUE, exact = TRUE)
```

```{r}
test %>% plot
```
```{r}
st_crop(gdd, rice_polys) %>% plot
```
```{r}
test <- st_rasterize(rice_polys, dx = 0.00833333) %>% st_warp(gdd)

plot(test, downsample = 1)



test2 <- gdd %>% 
  st_crop(test) %>% 
  st_as_stars()

test3 <- gdd %>%
  st_as_stars() %>%
  c(test) %>%
  as_tibble() %>%
  filter(!is.na(GDD10)) %>%
  mutate(type = if_else(is.na(type), 'no rice', as.character(type)))

test3 %>%
  ggplot(aes(GDD10, group = type, fill = type)) +
  geom_density(alpha = .5)

test3 %>%
  mutate(type = if_else(type == 'no rice', type, 'rice')) %>%
  ggplot(aes(GDD10, group = type, fill = type)) +
  geom_density(alpha = .5)
```
```{r}
as_tibble(test2) %>%
  left_join(as_tibble(test)) %>%
  remove_missing()

as_tibble(test) %>% remove_missing
as_tibble(test2) %>% remove_missing
```

